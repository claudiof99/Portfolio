<%- include('../partials/header') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Performance Analysis (Graphs)</h1>
    <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
</div>

<div class="row">
    <% kpis.forEach((k, index) => { %>
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5><%= k.name %> (<%= k.unit %>)</h5>
                    <canvas 
                        id="chart-<%= index %>" 
                        class="kpi-chart"
                        data-target="<%= k.target %>"
                        data-points="<%= JSON.stringify(k.dataPoints) %>">
                    </canvas>
                </div>
            </div>
        </div>
    <% }) %>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Select all canvas elements with the class 'kpi-chart'
        const charts = document.querySelectorAll('.kpi-chart');

        charts.forEach((canvas) => {
            const ctx = canvas.getContext('2d');
            
            // Read the data we hid in the HTML attributes
            const target = parseFloat(canvas.getAttribute('data-target'));
            const rawPoints = canvas.getAttribute('data-points');
            const dataPoints = JSON.parse(rawPoints);

            // Create the chart
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map(d => d.date),
                    datasets: [{
                        label: 'Actual Value',
                        data: dataPoints.map(d => d.value),
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        fill: true,
                        tension: 0.1
                    }, {
                        label: 'Target',
                        data: dataPoints.map(() => target),
                        borderColor: 'red',
                        borderDash: [5, 5], // Dashed line for target
                        pointRadius: 0,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    });
</script>

<%- include('../partials/footer') %>