
<%- include('partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-exclamation-triangle text-warning me-2"></i>Non-Conformities</h1>
    
    <div>
        <% if (currentUser && (currentUser.role === 'quality_manager' || currentUser.role === 'admin')) { %>
            <a href="/ncs/history" class="btn btn-secondary me-2">
                <i class="fas fa-history me-1"></i> View Log
            </a>
        <% } %>

        <a href="/dashboard" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

<div class="row">
    
    <div class="col-md-4 mb-4">
        <div class="card shadow-sm border-0 sticky-top" style="top: 20px; z-index: 1;">
            <div class="card-header bg-white border-bottom-0 pt-4">
                <h5 class="card-title mb-0 text-primary">Report New Issue</h5>
                <small class="text-muted">Fill in the details below.</small>
            </div>
            <div class="card-body">
                
                <form action="/ncs" method="POST" enctype="multipart/form-data">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Title / Subject</label>
                        <input type="text" name="titulo" class="form-control" placeholder="E.g. Leaking pipe in Sector B" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Description</label>
                        <textarea name="descricao" class="form-control" rows="5" placeholder="Describe the non-conformance in detail..." required></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Severity Level</label>
                        <select name="gravidade" class="form-select">
                            <option value="Baixa">Low (Observation)</option>
                            <option value="Media" selected>Medium (Minor NC)</option>
                            <option value="Alta">High (Major NC)</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Evidence (Optional)</label>
                        <input type="file" name="evidencia" class="form-control" accept="image/*">
                        <div class="form-text">Attach a photo or screenshot (JPG, PNG).</div>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Submit Report
                        </button>
                    </div>

                </form>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <h4 class="mb-3 text-muted">History & Logs</h4>

        <% if (!ncs || ncs.length === 0) { %>
            <div class="alert alert-light text-center border shadow-sm py-5">
                <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                <h5>No Non-Conformities Found</h5>
                <p class="text-muted">Great job! Everything seems to be in order.</p>
            </div>
        <% } else { %>
            
            <% ncs.forEach(function(nc) { 
                
                // --- COLOR LOGIC ---
                let borderClass = 'border-success'; 
                let badgeClass = 'bg-success';      
                let textoRisco = 'Low Risk';        

                if(nc.gravidade === 'Media') { 
                    borderClass = 'border-warning'; 
                    badgeClass = 'bg-warning text-dark';
                    textoRisco = 'Medium Risk';     
                }
                
                if(nc.gravidade === 'Alta') { 
                    borderClass = 'border-danger'; 
                    badgeClass = 'bg-danger';
                    textoRisco = 'High Risk';       
                }
            %>

            <div class="card shadow-sm mb-3 border-start border-4 <%= borderClass %>">
                <div class="card-body">
                    
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="card-title mb-1">
                                <%= nc.titulo %>
                            </h5>
                            <span class="badge <%= badgeClass %> mb-2"><%= textoRisco %></span>
                        </div>
                        <small class="text-muted">#ID <%= nc.id %></small>
                    </div>

                    <p class="card-text text-secondary mt-2" style="white-space: pre-wrap;"><%= nc.descricao %></p>

                    <% if (nc.evidencia) { %>
                        <div class="mt-3 p-2 bg-light rounded border">
                            <p class="mb-1 small fw-bold"><i class="fas fa-paperclip me-1"></i> Attachment:</p>
                            <img src="<%= nc.evidencia %>" class="img-fluid rounded shadow-sm" style="max-height: 300px;" alt="EvidÃªncia">
                        </div>
                    <% } %>

                    <div class="mt-3 border-top pt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="far fa-clock me-1"></i> 
                            <%= nc.dataCriacao ? new Date(nc.dataCriacao).toLocaleDateString() + ' ' + new Date(nc.dataCriacao).toLocaleTimeString() : 'Date N/A' %>
                        </small>
                        
                        <div>
                            <% if (currentUser && (currentUser.role === 'quality_manager' || currentUser.role === 'admin')) { %>
                                <form action="/ncs/delete/<%= nc.id %>" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this report?');">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Issue">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            <% } %>
                        </div>

                    </div>
                </div>
            </div>

            <% }); %>
        <% } %>
    </div>
</div>

<%- include('partials/footer') %>